<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¥¶ç‹—æ‰“å­—æœº</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#11111b">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==">
    <link rel="manifest" href='data:application/manifest+json;base64,ewogICJuYW1lIjogIlR5cGUgTWFzdGVyIiwKICAic2hvcnRfbmFtZSI6ICJUeXBlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMTExMWIiLAogICJ0aGVtZV9jb2xvciI6ICIjMTExMTFiIgp9'>

    <style>
        :root {
            --bg-color: #11111b; --key-bg: #313244; --text-color: #cdd6f4;
            --highlight-color: #f9a450; --correct-color: #a6e3a1; --wrong-color: #f38ba8;
            --modal-bg: rgba(24, 24, 37, 0.98);
        }
        body { background: var(--bg-color); color: var(--text-color); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        #app-wrapper { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }

        #login-screen { position: absolute; inset: 0; background: #11111b; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .user-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 800px; margin-bottom: 40px; }
        .user-card {
            background: #1e1e2e; border: 2px solid #313244; border-radius: 16px; width: 100px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .user-card:hover { border-color: var(--highlight-color); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(249,164,80,0.3); }
        .user-avatar-big { font-size: 3rem; margin-bottom: 10px; }
        .user-name { font-weight: bold; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }

        .new-user-box { background: #181825; padding: 20px; border-radius: 16px; border: 1px solid #313244; text-align: center; }
        .avatar-selector { display: flex; gap: 10px; margin: 15px 0; justify-content: center; }
        .avatar-option { font-size: 1.5rem; cursor: pointer; opacity: 0.5; transition: 0.2s; filter: grayscale(1); }
        .avatar-option.selected { opacity: 1; transform: scale(1.3); filter: grayscale(0); }
        .user-input { padding: 10px; border-radius: 8px; border: 1px solid #45475a; background: #313244; color: #fff; text-align: center; width: 150px; }
        .add-btn { background: var(--highlight-color); border: none; padding: 10px 20px; border-radius: 8px; color: #1e1e2e; font-weight: bold; cursor: pointer; margin-top: 10px; }

        #start-screen { position: absolute; inset: 0; background: rgba(17,17,27,0.98); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .top-bar { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        .icon-btn { background: rgba(255,255,255,0.1); border: 1px solid #45475a; color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .pk-btn { border-color: var(--highlight-color); color: var(--highlight-color); }

        .current-user-badge { position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        
        .recent-badges { display: flex; gap: 15px; margin-bottom: 30px; min-height: 80px; }
        .mini-badge { width: 60px; height: 60px; background: #1e1e2e; border: 2px solid #313244; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; position: relative; cursor: pointer; }
        .mini-badge:hover { border-color: var(--highlight-color); transform: scale(1.1); }
        .mini-badge .tooltip { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); background: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; }
        .mini-badge:hover .tooltip { opacity: 1; }

        .control-group { margin-bottom: 30px; display: flex; flex-direction: column; gap: 15px; width: 300px; }
        .word-select { padding: 12px; background: var(--key-bg); color: #fff; border: 2px solid var(--highlight-color); border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .start-btn { padding: 15px 50px; font-size: 1.5rem; background: var(--highlight-color); border: none; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 0 20px rgba(249,164,80,0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2500; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--modal-bg); width: 600px; max-width: 90%; border-radius: 20px; padding: 30px; border: 1px solid #45475a; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: #6c7086; font-size: 1.5rem; cursor: pointer; }

        .leaderboard-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #313244; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #6c7086; font-size: 1.1rem; cursor: pointer; padding: 5px 10px; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid var(--highlight-color); }
        .rank-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #313244; }
        .rank-num { font-size: 1.2rem; font-weight: bold; width: 40px; color: #6c7086; }
        .rank-num.top1 { color: #f9e2af; text-shadow: 0 0 10px #f9e2af; }
        .rank-avatar { font-size: 1.5rem; margin-right: 15px; }
        .rank-name { flex: 1; color: #fff; font-weight: bold; }
        .rank-score { font-family: monospace; font-size: 1.2rem; color: var(--highlight-color); }

        .display-area { width: 80%; height: 140px; background: #181825; border-radius: 16px; display: flex; align-items: center; overflow: hidden; position: relative; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); mask-image: linear-gradient(90deg, transparent, #000 10%, #000 90%, transparent); }
        #display-track { display: flex; align-items: flex-end; padding-left: 50%; transition: transform 0.2s cubic-bezier(0.2,0,0.2,1); }
        .word-block { display: flex; flex-direction: column; align-items: center; margin-right: 40px; }
        .word-en { font-size: 3rem; display: flex; }
        .word-zh { font-size: 1.2rem; color: #6c7086; margin-top: 5px; }
        .char { padding: 0 2px; border-radius: 4px; }
        .char.correct { color: var(--correct-color); }
        .char.wrong { color: var(--wrong-color); text-decoration: line-through; }
        .char.current { background: rgba(255,255,255,0.15); border-bottom: 3px solid var(--highlight-color); }

        .keyboard-container { position: relative; padding: 30px; background: #0d0d15; border-radius: 20px; border: 3px solid #313244; }
        .keyboard { display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; justify-content: center; gap: 6px; }
        .key { width: 50px; height: 50px; background: var(--key-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #a6adc8; border-bottom: 4px solid #181825; transition: 0.1s; cursor: pointer; }
        .key.active { transform: translateY(4px); border-bottom: 0; background: var(--highlight-color); color: #1e1e2e; }
        .key.space { width: 300px; font-size: 0.8rem; color: rgba(255,255,255,0.15); font-family: "Microsoft YaHei", sans-serif; display: flex; align-items: center; justify-content: center;}
        .key.space.active { color: rgba(0,0,0,0.4); }

        .stats-bar { display: flex; gap: 30px; margin-bottom: 20px; color: #6c7086; }
        .stat-value { font-size: 1.5rem; color: #fff; font-weight: bold; }
        
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th, .history-table td { padding: 10px; text-align: left; border-bottom: 1px solid #313244; }
        .history-table th { color: #6c7086; }
        #chart-container { height: 250px; width: 100%; margin-top: 20px; position:relative; }
        .chart-legend { display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; color: #6c7086; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        .game-exit-btn { position: absolute; top: 20px; right: 20px; background: transparent; border: 1px solid #45475a; color: #6c7086; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; z-index: 100; }
        .game-exit-btn:hover { border-color: #f38ba8; color: #f38ba8; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--correct-color); color: #1e1e2e; padding: 10px 20px; border-radius: 20px; font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; }
        
        /* è§¦æ‘¸äº‹ä»¶ä¸è§¦å‘ç¼©æ”¾ */
        .key { touch-action: manipulation; }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <button class="game-exit-btn" onclick="logout()">âœ• é€€å‡ºç™»å½•</button>

        <div id="login-screen">
            <h1 style="color:#fff; margin-bottom: 10px; font-size: 2.5rem;">ğŸ¶ å°å¥¶ç‹—æ‰“å­—æœº</h1>
            <p style="color:#6c7086; margin-bottom: 40px;">Who is typing today?</p>
            <div id="user-grid" class="user-grid"></div>
            <div class="new-user-box">
                <div style="color:#fff; margin-bottom:10px;">åˆ›å»ºæ–°ç”¨æˆ·</div>
                <div class="avatar-selector" id="avatar-selector">
                    <div class="avatar-option selected">ğŸ¶</div>
                    <div class="avatar-option">ğŸ±</div>
                    <div class="avatar-option">ğŸ¦Š</div>
                    <div class="avatar-option">ğŸ¼</div>
                    <div class="avatar-option">ğŸ¯</div>
                    <div class="avatar-option">ğŸ¦</div>
                </div>
                <input type="text" id="new-username" class="user-input" placeholder="è¾“å…¥åå­—..." maxlength="8">
                <br>
                <button class="add-btn" onclick="createNewUser()">åŠ å…¥å¤§å®¶åº­</button>
            </div>
        </div>

        <div id="start-screen">
            <div class="current-user-badge">
                <span id="current-avatar">ğŸ¶</span>
                <span id="current-name" style="color:#fff; font-weight:bold;">Player</span>
            </div>
            <div class="top-bar">
                <button class="icon-btn pk-btn" onclick="showLeaderboard()">ğŸ† PKæ’è¡Œæ¦œ</button>
                <button class="icon-btn" onclick="toggleModal('history-modal', true)">ğŸ“Š æˆ‘çš„æ•°æ®</button>
                <button class="icon-btn" onclick="toggleModal('badge-modal', true)">ğŸ… å¾½ç« åº“</button>
            </div>
            <h1 style="color:#fff; font-size: 3rem; margin-bottom: 10px;">Type Master</h1>
            <div class="section-title">æˆ‘çš„æœ€æ–°æˆå°±</div>
            <div class="recent-badges" id="recent-badges-container"></div>
            <div class="control-group">
                <select id="word-bank-select" class="word-select">
                    <option value="elementary">åŠ è½½ä¸­...</option>
                </select>
                <button class="start-btn" onclick="startGame()">å¼€å§‹æ‰“å­—</button>
            </div>
        </div>

        <div id="achievement-overlay" onclick="closeAchievement()"><canvas id="fireworks-canvas"></canvas><div class="achievement-card"><div class="achievement-icon" id="unlock-icon">ğŸ†</div><div class="achievement-title">è§£é”æˆå°±ï¼</div><div class="achievement-desc" id="unlock-desc"></div><div style="margin-top:20px; font-size:0.9rem; color:#6c7086;">ç‚¹å‡»å±å¹•ç»§ç»­</div></div></div>
        <div id="detail-overlay" onclick="closeDetailOverlay()"><div class="achievement-card" style="box-shadow:0 0 30px var(--highlight-color); border-color:#45475a;"><div class="achievement-icon" id="detail-icon" style="animation:none; font-size:3.5rem;"></div><div class="achievement-title" id="detail-title"></div><div class="achievement-desc" id="detail-desc"></div><div style="margin-top:20px; font-size:0.8rem; color:#6c7086;">ç‚¹å‡»å…³é—­</div></div></div>

        <div id="leaderboard-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="toggleModal('leaderboard-modal', false)">Ã—</button>
                <h2 style="color:#fff; margin-bottom:20px;">ğŸ† å…¨æœ PK æ’è¡Œæ¦œ</h2>
                <div class="leaderboard-tabs">
                    <button class="tab-btn active" onclick="renderLeaderboard('speed')">âš¡ï¸ å”¯å¿«ä¸ç ´ (WPM)</button>
                    <button class="tab-btn" onclick="renderLeaderboard('volume')">ğŸ“š å·ç‹ä¹‹ç‹ (å­—æ•°)</button>
                    <button class="tab-btn" onclick="renderLeaderboard('accuracy')">ğŸ¯ é›¶å¤±è¯¯ (å®Œç¾)</button>
                </div>
                <div id="leaderboard-list"></div>
            </div>
        </div>

        <div id="history-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="toggleModal('history-modal', false)">Ã—</button>
                <h2 style="color:#fff;">ğŸ“Š å†å²æˆ˜ç»©</h2>
                <div id="history-list-view"></div>
                <div id="chart-container"><canvas id="history-chart"></canvas></div>
                <div class="chart-legend" id="chart-legend"><div class="legend-item"><div class="legend-dot" style="background:#f9a450"></div>WPM</div><div class="legend-item"><div class="legend-dot" style="background:#a6e3a1"></div>å‡†ç¡®ç‡</div></div>
            </div>
        </div>

        <div id="badge-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="toggleModal('badge-modal', false)">Ã—</button>
                <h2 style="color:#fff;">ğŸ… å¾½ç« å±•ç¤ºæŸœ</h2>
                <div class="badge-grid" id="badge-library-grid"></div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item"><span>æ—¶é—´</span> <span id="time-elapsed" class="stat-value">00:00</span></div>
            <div class="stat-item"><span>WPM</span> <span id="wpm" class="stat-value">0</span></div>
            <div class="stat-item"><span>å‡†ç¡®ç‡</span> <span id="accuracy" class="stat-value">100%</span></div>
            <div class="stat-item"><span>è¿å‡»</span> <span id="combo" class="stat-value" style="color:var(--highlight-color)">0</span></div>
        </div>

        <div class="display-area" id="display-container"><div id="display-track"></div></div>

        <div class="keyboard-container" id="keyboard-container">
            <div class="keyboard">
                <div class="row"><div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div><div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div><div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div><div class="key" data-key="p">P</div></div>
                <div class="row"><div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div><div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div><div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div></div>
                <div class="row"><div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div><div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div><div class="key" data-key="m">M</div></div>
                <div class="row"><div class="key space" data-key=" ">çš®çš®&å›¢å›¢çš„daddyåˆ¶ä½œ</div></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">è®°å½•å·²ä¿å­˜</div>

    <script>
        const API_URL = "https://dz.509992828.de5.net";

        let currentUser=null, currentUserId=null, currentAvatar='ğŸ¶', userStats={}, leaderboardData=[], wordBanks={};
        let currentWordsData=[], currentTextStr="", currentIndex=0, correctKeys=0, totalKeys=0, combo=0, startTime=null, timerInterval=null, sessionStartTime=null, allCharElements=[];
        const COMBO_THRESHOLD=20, USERS_KEY='typeMaster_users';
        const keyMap={'q':{h:'L',f:'pinky'},'a':{h:'L',f:'pinky'},'z':{h:'L',f:'pinky'},'w':{h:'L',f:'ring'},'s':{h:'L',f:'ring'},'x':{h:'L',f:'ring'},'e':{h:'L',f:'middle'},'d':{h:'L',f:'middle'},'c':{h:'L',f:'middle'},'r':{h:'L',f:'index'},'f':{h:'L',f:'index'},'v':{h:'L',f:'index'},'t':{h:'L',f:'index'},'g':{h:'L',f:'index'},'b':{h:'L',f:'index'},'y':{h:'R',f:'index'},'h':{h:'R',f:'index'},'n':{h:'R',f:'index'},'u':{h:'R',f:'index'},'j':{h:'R',f:'index'},'m':{h:'R',f:'index'},'i':{h:'R',f:'middle'},'k':{h:'R',f:'middle'},',':{h:'R',f:'middle'},'o':{h:'R',f:'ring'},'l':{h:'R',f:'ring'},'.':{h:'R',f:'ring'},'p':{h:'R',f:'pinky'},';':{h:'R',f:'pinky'},'/':{h:'R',f:'pinky'},'[':{h:'R',f:'pinky'},']':{h:'R',f:'pinky'},"'":{h:'R',f:'pinky'},' ':{h:'R',f:'thumb'}};
        const achievements=[{id:'1',icon:'ğŸ†',name:'åˆå‡ºèŒ…åº',desc:'å®Œæˆç¬¬1æ¬¡ç»ƒä¹ ',check:s=>s.totalRounds>=1},{id:'2',icon:'ğŸŒ±',name:'æ¸å…¥ä½³å¢ƒ',desc:'å®Œæˆ10æ¬¡ç»ƒä¹ ',check:s=>s.totalRounds>=10},{id:'3',icon:'ğŸŒ²',name:'ç†Ÿèƒ½ç”Ÿå·§',desc:'å®Œæˆ50æ¬¡ç»ƒä¹ ',check:s=>s.totalRounds>=50},{id:'4',icon:'ğŸ‘‘',name:'é”®ç›˜ä¹‹ç‹',desc:'å®Œæˆ100æ¬¡ç»ƒä¹ ',check:s=>s.totalRounds>=100},{id:'5',icon:'âš¡ï¸',name:'é—ªç”µä¾ ',desc:'é€Ÿåº¦è¶…è¿‡ 40 WPM',check:s=>s.lastWpm>40},{id:'6',icon:'ğŸš€',name:'è¶…éŸ³é€Ÿ',desc:'é€Ÿåº¦è¶…è¿‡ 60 WPM',check:s=>s.lastWpm>60},{id:'7',icon:'ğŸ›¸',name:'å…‰é€ŸæŒ‡æ³•',desc:'é€Ÿåº¦è¶…è¿‡ 80 WPM',check:s=>s.lastWpm>80},{id:'8',icon:'ğŸŒŒ',name:'æ—¶ç©ºç©¿æ¢­',desc:'é€Ÿåº¦è¶…è¿‡ 100 WPM',check:s=>s.lastWpm>100},{id:'9',icon:'ğŸ‘½',name:'å¤–æ˜Ÿæ‰‹é€Ÿ',desc:'é€Ÿåº¦è¶…è¿‡ 120 WPM',check:s=>s.lastWpm>120},{id:'10',icon:'ğŸ¯',name:'ç¥å°„æ‰‹',desc:'å‡†ç¡®ç‡ 100% å®Œæˆä¸€è½®',check:s=>s.lastAcc===100&&s.roundKeys>10},{id:'11',icon:'ğŸ’',name:'å®Œç¾ä¸»ä¹‰',desc:'ç´¯è®¡10æ¬¡å®Œç¾å›åˆ',check:s=>s.totalPerfectRounds>=10},{id:'12',icon:'ğŸ”¬',name:'é›¶å¤±è¯¯å¤§å¸ˆ',desc:'ç´¯è®¡50æ¬¡å®Œç¾å›åˆ',check:s=>s.totalPerfectRounds>=50},{id:'13',icon:'ğŸ”¥',name:'ç«åŠ›å…¨å¼€',desc:'å•æ¬¡è¿å‡»è¶…è¿‡ 50',check:s=>s.maxCombo>=50},{id:'14',icon:'ğŸŒ‹',name:'å¿ƒæµçŠ¶æ€',desc:'å•æ¬¡è¿å‡»è¶…è¿‡ 100',check:s=>s.maxCombo>=100},{id:'15',icon:'ğŸŒªï¸',name:'æš´é£éª¤é›¨',desc:'å•æ¬¡è¿å‡»è¶…è¿‡ 200',check:s=>s.maxCombo>=200},{id:'16',icon:'âš¡ï¸',name:'è¿å‡»ä¹‹ç¥',desc:'å•æ¬¡è¿å‡»è¶…è¿‡ 500',check:s=>s.maxCombo>=500},{id:'17',icon:'ğŸ“œ',name:'å­¦ç«¥',desc:'ç´¯è®¡è¾“å…¥ 500 ä¸ªå•è¯',check:s=>s.totalWords>=500},{id:'18',icon:'ğŸ“š',name:'å­¦è€…',desc:'ç´¯è®¡è¾“å…¥ 2000 ä¸ªå•è¯',check:s=>s.totalWords>=2000},{id:'19',icon:'ğŸ§™â€â™‚ï¸',name:'å¤§è´¤è€…',desc:'ç´¯è®¡è¾“å…¥ 10000 ä¸ªå•è¯',check:s=>s.totalWords>=10000},{id:'20',icon:'ğŸ“–',name:'ä¼ å¥‡',desc:'ç´¯è®¡è¾“å…¥ 50000 ä¸ªå•è¯',check:s=>s.totalWords>=50000},{id:'21',icon:'ğŸ•’',name:'å‹¤å¥‹ä¹‹æ˜Ÿ',desc:'ç´¯è®¡ç»ƒä¹ è¶…è¿‡ 1 å°æ—¶',check:s=>s.totalTime>=3600},{id:'22',icon:'ğŸƒâ€â™‚ï¸',name:'é©¬æ‹‰æ¾',desc:'ç´¯è®¡ç»ƒä¹ è¶…è¿‡ 5 å°æ—¶',check:s=>s.totalTime>=18000},{id:'23',icon:'ğŸ‹ï¸â€â™‚ï¸',name:'é’¢é“æ„å¿—',desc:'ç´¯è®¡ç»ƒä¹ è¶…è¿‡ 10 å°æ—¶',check:s=>s.totalTime>=36000},{id:'24',icon:'ğŸ§˜â€â™‚ï¸',name:'ç¦…å®š',desc:'ç´¯è®¡ç»ƒä¹ è¶…è¿‡ 24 å°æ—¶',check:s=>s.totalTime>=86400},{id:'25',icon:'ğŸ¦‰',name:'å¤œçŒ«å­',desc:'åœ¨æ™šä¸Š 10 ç‚¹åç»ƒä¹ ',check:s=>new Date().getHours()>=22},{id:'26',icon:'â˜€ï¸',name:'æ—©èµ·çš„é¸Ÿå„¿',desc:'åœ¨æ—©ä¸Š 5-8 ç‚¹ç»ƒä¹ ',check:s=>{const h=new Date().getHours();return h>=5&&h<=8}},{id:'27',icon:'ğŸ“…',name:'å‘¨æœ«æˆ˜å£«',desc:'åœ¨å‘¨å…­æˆ–å‘¨æ—¥ç»ƒä¹ ',check:s=>{const d=new Date().getDay();return d===0||d===6}},{id:'28',icon:'ğŸ¢',name:'æ…¢åå',desc:'WPMä½äº10ä½†åšæŒå®Œæˆ',check:s=>s.lastWpm<10&&s.lastWpm>0},{id:'29',icon:'ğŸ”¨',name:'é”®å¸½ç ´åè€…',desc:'ç´¯è®¡æŒ‰é”® 10,000 æ¬¡',check:s=>s.totalKeystrokes>=10000},{id:'30',icon:'ğŸ¹',name:'é’¢ç´å®¶',desc:'ç´¯è®¡æŒ‰é”® 50,000 æ¬¡',check:s=>s.totalKeystrokes>=50000}];

        fetchUsers(); fetchWordBanks(); setupAvatarSelector();

        async function fetchWordBanks(){try{const res=await fetch(`${API_URL}/api/wordbanks`);wordBanks=await res.json();const select=document.getElementById('word-bank-select');select.innerHTML='';const names={elementary:"ğŸ“š å°å­¦å…¨èƒ½è¯åº“",python:"ğŸ Python ç¼–ç¨‹è¯åº“"};Object.keys(wordBanks).forEach(key=>{const opt=document.createElement('option');opt.value=key;opt.innerText=names[key]||key;select.appendChild(opt)})}catch(e){console.error("åŠ è½½è¯åº“å¤±è´¥",e)}}
        async function fetchUsers(){try{const res=await fetch(`${API_URL}/api/users`);const users=await res.json();const grid=document.getElementById('user-grid');grid.innerHTML='';users.forEach(u=>{const card=document.createElement('div');card.className='user-card';card.onclick=()=>login(u.name,u.avatar);card.innerHTML=`<div class="user-avatar-big">${u.avatar}</div><div class="user-name">${u.name}</div>`;grid.appendChild(card)})}catch(e){console.error(e)}}
        function setupAvatarSelector(){document.querySelectorAll('.avatar-option').forEach(el=>{el.onclick=()=>{document.querySelectorAll('.avatar-option').forEach(a=>a.classList.remove('selected'));el.classList.add('selected')}})}
        async function createNewUser(){const name=document.getElementById('new-username').value.trim();const avatar=document.querySelector('.avatar-option.selected').innerText;if(!name)return alert("è¯·è¾“å…¥åå­—");await login(name,avatar);fetchUsers()}
        async function login(name,avatar){try{const res=await fetch(`${API_URL}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,avatar})});const data=await res.json();currentUser=data.user.name;currentUserId=data.user.id;currentAvatar=data.user.avatar;userStats=data.stats;try{userStats.unlocked=JSON.parse(userStats.unlocked_badges||'[]')}catch(e){userStats.unlocked=[]}['totalRounds','totalTime','totalWords','maxCombo','max_wpm','totalPerfectRounds','totalKeystrokes'].forEach(k=>{if(!userStats[k])userStats[k]=0});document.getElementById('login-screen').style.display='none';document.getElementById('start-screen').style.display='flex';document.getElementById('current-avatar').innerText=currentAvatar;document.getElementById('current-name').innerText=currentUser;renderMyBadges()}catch(e){alert("ç™»å½•å¤±è´¥")}}
        function logout(){document.getElementById('start-screen').style.display='none';document.getElementById('login-screen').style.display='flex';document.getElementById('display-container').style.display='none';fetchUsers()}
        async function showLeaderboard(){toggleModal('leaderboard-modal',true);const res=await fetch(`${API_URL}/api/leaderboard`);leaderboardData=await res.json();renderLeaderboard('speed')}
        function renderLeaderboard(type){const list=document.getElementById('leaderboard-list');list.innerHTML='';let sorted=[...leaderboardData];if(type==='speed')sorted.sort((a,b)=>b.max_wpm-a.max_wpm);if(type==='volume')sorted.sort((a,b)=>b.totalWords-a.totalWords);if(type==='accuracy')sorted.sort((a,b)=>b.totalPerfectRounds-a.totalPerfectRounds);document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));const idx=type==='speed'?0:type==='volume'?1:2;document.querySelectorAll('.tab-btn')[idx].classList.add('active');sorted.forEach((u,index)=>{const item=document.createElement('div');item.className='rank-item';let score='';if(type==='speed')score=`${u.max_wpm} WPM`;if(type==='volume')score=`${u.totalWords} å­—`;if(type==='accuracy')score=`${u.totalPerfectRounds} æ¬¡å®Œç¾`;item.innerHTML=`<div class="rank-num ${index===0?'top1':''}">${index+1}</div><div class="rank-avatar">${u.avatar}</div><div class="rank-name">${u.name}</div><div class="rank-score">${score}</div>`;list.appendChild(item)})}
        
        function startGame(){const bank=document.getElementById('word-bank-select').value;currentWordsData=wordBanks[bank];let round=[];for(let i=0;i<20;i++)round.push(currentWordsData[Math.floor(Math.random()*currentWordsData.length)]);currentTextStr=round.map(w=>w.en).join(" ");currentIndex=0;correctKeys=0;totalKeys=0;combo=0;startTime=null;renderText(round);document.getElementById('start-screen').style.display='none';document.getElementById('display-container').style.display='flex';sessionStartTime=Date.now();if(timerInterval)clearInterval(timerInterval);timerInterval=setInterval(()=>{const diff=Math.floor((Date.now()-sessionStartTime)/1000);document.getElementById('time-elapsed').innerText=`${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`},1000)}
        function renderText(words){const track=document.getElementById('display-track');track.innerHTML='';allCharElements=[];words.forEach((w,idx)=>{const block=document.createElement('div');block.className='word-block';const en=document.createElement('div');en.className='word-en';w.en.split('').forEach(c=>{const span=document.createElement('span');span.innerText=c;span.className='char';en.appendChild(span);allCharElements.push(span)});if(idx<words.length-1){const span=document.createElement('span');span.innerText=' ';span.className='char space-char';en.appendChild(span);allCharElements.push(span)}const zh=document.createElement('div');zh.className='word-zh';zh.innerText=w.zh;block.appendChild(en);block.appendChild(zh);track.appendChild(block)});if(allCharElements.length>0)allCharElements[0].classList.add('current');autoScroll()}
        function autoScroll(){const el=allCharElements[currentIndex];if(el){const con=document.getElementById('display-container');const offset=el.getBoundingClientRect().left-document.getElementById('display-track').getBoundingClientRect().left;const center=con.offsetWidth/2-el.offsetWidth/2;document.getElementById('display-track').style.transform=`translateX(${center-offset}px)`}}
        function saveRound(wpm,acc){userStats.totalRounds++;userStats.totalWords+=20;if(acc===100)userStats.totalPerfectRounds++;if(wpm>userStats.max_wpm)userStats.max_wpm=wpm;if(combo>userStats.maxCombo)userStats.maxCombo=combo;const timeStr=new Date().toLocaleString('zh-CN');fetch(`${API_URL}/api/save`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUserId,record:{wpm,acc:acc+'%',count:20,time:timeStr},stats:userStats})}).then(()=>{document.getElementById('toast').classList.add('show');setTimeout(()=>document.getElementById('toast').classList.remove('show'),2000);setTimeout(()=>{document.getElementById('start-screen').style.display='flex';renderMyBadges()},1000)})}
        
        document.addEventListener('keydown',(e)=>{
            if(document.getElementById('start-screen').style.display!=='none'||document.getElementById('login-screen').style.display!=='none')return;
            if(['Shift','Alt','Control','Meta','CapsLock'].includes(e.key))return;
            if(!startTime)startTime=Date.now();
            const key=e.key.length===1?e.key.toLowerCase():e.key;const target=currentTextStr[currentIndex]?.toLowerCase();
            const vKey=document.querySelector(`.key[data-key="${key}"]`)||document.querySelector(`.key[data-key="${e.key}"]`);
            if(vKey){vKey.classList.add('active');setTimeout(()=>vKey.classList.remove('active'),100);const rect=vKey.getBoundingClientRect();const ripple=document.createElement('div');ripple.className='key-ripple';ripple.style.left=(rect.left+rect.width/2)+'px';ripple.style.top=(rect.top+rect.height/2)+'px';document.body.appendChild(ripple);setTimeout(()=>ripple.remove(),600)}
            if(key==='Backspace'){if(currentIndex>0){currentIndex--;allCharElements[currentIndex].className=allCharElements[currentIndex].innerText===' '?'char space-char':'char';allCharElements[currentIndex].classList.add('current');if(allCharElements[currentIndex+1])allCharElements[currentIndex+1].classList.remove('current');autoScroll()}return}
            if(!target)return; totalKeys++;
            if(key===target){
                correctKeys++;combo++;allCharElements[currentIndex].classList.add('correct');allCharElements[currentIndex].classList.remove('current');
                if(combo>=20){document.body.classList.add('on-fire');document.getElementById('keyboard-container').classList.add('rgb-mode');if(vKey){for(let i=0;i<20;i++){const p=document.createElement('div');p.className='particle';document.body.appendChild(p);const s=Math.random()*8+4;p.style.width=s+'px';p.style.height=s+'px';p.style.background=Math.random()>0.7?'#fff':'#f9e2af';const rect=vKey.getBoundingClientRect();p.style.left=(rect.left+rect.width/2)+'px';p.style.top=(rect.top+rect.height/2)+'px';const a=Math.random()*Math.PI*2,v=Math.random()*150+50;p.animate([{transform:'translate(0,0)',opacity:1},{transform:`translate(${Math.cos(a)*v}px,${Math.sin(a)*v}px)`,opacity:0}],{duration:600}).onfinish=()=>p.remove()}}}
                checkAchievements({maxCombo:combo});
                // å•è¯å‘éŸ³é€»è¾‘
                let spaceCount=0;for(let i=0;i<currentIndex;i++)if(currentTextStr[i]===' ')spaceCount++;
                if(target===' '){if(currentWordsData[spaceCount])speakWord(currentWordsData[spaceCount].en)}
                else if(currentIndex===currentTextStr.length-1){if(currentWordsData[currentWordsData.length-1])speakWord(currentWordsData[currentWordsData.length-1].en)}
                
                currentIndex++;if(currentIndex<currentTextStr.length)allCharElements[currentIndex].classList.add('current');
                else{const wpm=Math.round((correctKeys/5)/((Date.now()-startTime)/60000));const acc=Math.round((correctKeys/totalKeys)*100);saveRound(wpm,acc)}
            }else{combo=0;document.body.classList.remove('on-fire');document.getElementById('keyboard-container').classList.remove('rgb-mode');allCharElements[currentIndex].classList.add('wrong')}
            document.getElementById('wpm').innerText=startTime?Math.round((correctKeys/5)/((Date.now()-startTime)/60000)):0;document.getElementById('accuracy').innerText=Math.round((correctKeys/totalKeys)*100)+'%';document.getElementById('combo').innerText=combo;autoScroll()
        });

        // è¾…åŠ©å‡½æ•°
        function toggleModal(id,show){document.getElementById(id).style.display=show?'flex':'none';if(id==='history-modal'&&show){loadHistory()}}
        function renderMyBadges(){const c=document.getElementById('recent-badges-container');c.innerHTML='';userStats.unlocked.slice(-5).reverse().forEach(id=>{const a=achievements.find(x=>x.id===id);if(a){const e=document.createElement('div');e.className='mini-badge';e.onclick=()=>showDetailOverlay(a);e.innerHTML=`${a.icon}<div class="tooltip">${a.name}</div>`;c.appendChild(e)}})}
        function speakWord(t){if(!window.speechSynthesis)return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='en-US';u.rate=0.8;window.speechSynthesis.speak(u)}
        async function loadHistory(){
            const res=await fetch(`${API_URL}/api/history/${currentUserId}`);const data=await res.json();
            const list=document.getElementById('history-list-view');list.innerHTML='';data.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.timestamp}</td><td>${r.count}</td><td>${r.wpm}</td><td>${r.acc}</td>`;list.appendChild(tr)});
            // Render Chart
            const ctx=document.getElementById('history-chart').getContext('2d');const h=data.reverse();if(h.length<2)return;
            const w=ctx.canvas.width=document.getElementById('chart-container').offsetWidth;const ht=ctx.canvas.height=250;
            const p=30;ctx.strokeStyle='#313244';ctx.beginPath();ctx.moveTo(p,p);ctx.lineTo(p,ht-p);ctx.lineTo(w-p,ht-p);ctx.stroke();
            const getX=i=>p+(i/(h.length-1))*(w-p*2);const getY=v=>(ht-p)-(v/150)*(ht-p*2);
            [['wpm','#f9a450'],['acc','#a6e3a1']].forEach(([k,c])=>{
                ctx.strokeStyle=c;ctx.lineWidth=2;ctx.beginPath();
                h.forEach((d,i)=>{const v=k==='acc'?parseInt(d.acc):d.wpm;const x=getX(i),y=getY(v);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)});ctx.stroke();
            });
        }
    </script>
</body>
</html>
