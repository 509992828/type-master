<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Type Master: Family Edition</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#11111b">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==">
    <link rel="manifest" href='data:application/manifest+json;base64,ewogICJuYW1lIjogIlR5cGUgTWFzdGVyIiwKICAic2hvcnRfbmFtZSI6ICJUeXBlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMTExMWIiLAogICJ0aGVtZV9jb2xvciI6ICIjMTExMTFiIgp9'>

    <style>
        :root {
            --bg-color: #11111b;
            --key-bg: #313244;
            --key-shadow: #181825;
            --text-color: #cdd6f4;
            --sub-text-color: #7f849c; 
            --correct-color: #a6e3a1; 
            --wrong-color: #f38ba8;   
            --highlight-color: #f9a450; 
            --fire-core: #f9e2af;
            --fire-outer: #f38ba8;
            --hand-stroke: #6c7086;
            --hand-fill: rgba(108, 112, 134, 0.05);
            --modal-bg: rgba(24, 24, 37, 0.98);
        }

        html, body {
            height: 100%; width: 100%; overflow: hidden; position: fixed;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Courier New', Courier, monospace; margin: 0; padding: 0;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #app-wrapper {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden; position: relative;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(17, 17, 27, 1); z-index: 2000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .user-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px; max-width: 600px; width: 90%; margin-bottom: 30px;
        }

        .user-card {
            background: #1e1e2e; border: 2px solid #313244; border-radius: 12px;
            padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .user-card:hover { border-color: var(--highlight-color); transform: translateY(-5px); }
        .user-avatar { font-size: 2.5rem; margin-bottom: 10px; }
        .user-name { font-weight: bold; color: #fff; }

        .new-user-form { display: flex; gap: 10px; margin-top: 20px; }
        .user-input { padding: 10px; border-radius: 8px; border: 1px solid #45475a; background: #181825; color: #fff; outline: none; }
        .add-user-btn { padding: 10px 20px; background: var(--highlight-color); color: #1e1e2e; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- Start Screen --- */
        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(17, 17, 27, 0.98); z-index: 999; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        
        .section-title { font-size: 0.9rem; color: #6c7086; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }

        .recent-badges { display: flex; gap: 15px; margin-bottom: 30px; justify-content: center; min-height: 80px; }
        .mini-badge {
            background: #1e1e2e; width: 60px; height: 60px; border-radius: 50%;
            border: 2px solid #313244; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s; cursor: pointer;
        }
        .mini-badge:hover { transform: scale(1.1); border-color: var(--highlight-color); }
        .mini-badge.empty { border: 2px dashed #313244; color: #313244; font-size: 1.2rem; cursor: default; }
        .mini-badge .tooltip {
            position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 4px 8px; border-radius: 4px; 
            font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .mini-badge:hover .tooltip { opacity: 1; }

        .control-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; width: 300px; }
        .word-select, .file-input-label { padding: 12px 20px; font-size: 1.1rem; background: var(--key-bg); color: #fff; border: 2px solid var(--highlight-color); border-radius: 8px; cursor: pointer; outline: none; text-align: center; transition: all 0.2s; }
        .file-input-label:hover, .word-select:hover { background: #45475a; }
        #custom-file-input { display: none; }
        
        .btn-group { display: flex; gap: 15px; }
        .start-btn, .action-btn, .logout-btn { padding: 12px 25px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.1s; }
        .start-btn { background: var(--highlight-color); color: #1e1e2e; box-shadow: 0 0 20px rgba(249, 164, 80, 0.4); font-size: 1.3rem; padding: 15px 40px;}
        .action-btn { background: #313244; color: #cdd6f4; border: 1px solid #45475a; }
        .logout-btn { background: transparent; color: #f38ba8; border: 1px solid #f38ba8; font-size: 0.9rem; margin-top: 20px; }
        .start-btn:active, .action-btn:active { transform: scale(0.95); }
        .action-btn:hover { border-color: var(--highlight-color); color: #fff; }
        .logout-btn:hover { background: #f38ba8; color: #1e1e2e; }

        /* Ê∏∏ÊàèÁïåÈù¢ÈÄÄÂá∫ÊåâÈíÆ */
        .game-exit-btn {
            position: absolute; top: 20px; right: 20px;
            background: transparent; border: 1px solid #45475a; color: #6c7086;
            padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s; z-index: 100;
        }
        .game-exit-btn:hover { border-color: #f38ba8; color: #f38ba8; }

        /* --- Effects --- */
        .key-ripple {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; pointer-events: none; width: 0; height: 0;
            border: 2px solid var(--highlight-color);
            box-shadow: 0 0 10px var(--highlight-color), inset 0 0 10px var(--highlight-color);
            opacity: 1; animation: tech-ripple 0.5s cubic-bezier(0, 0.2, 0.5, 1) forwards; z-index: 100;
        }
        body.on-fire .key-ripple { border-color: var(--fire-core); box-shadow: 0 0 15px var(--fire-outer), inset 0 0 10px var(--fire-core); }
        @keyframes tech-ripple { 0% { width: 20px; height: 20px; opacity: 0.8; border-width: 4px; } 100% { width: 150px; height: 150px; opacity: 0; border-width: 0px; } }

        @keyframes rgb-flow {
            0% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            20% { border-color: #ffff00; box-shadow: 0 0 15px #ffff00; }
            40% { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
            60% { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; }
            80% { border-color: #0000ff; box-shadow: 0 0 15px #0000ff; }
            100% { border-color: #ff00ff; box-shadow: 0 0 15px #ff00ff; }
        }
        .keyboard-container { 
            position: relative; padding: 40px; background: #0d0d15; border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); border: 3px solid #313244; 
            margin-bottom: 20px; transition: border-color 0.3s; 
            -webkit-tap-highlight-color: transparent;
        }
        .keyboard-container.rgb-mode { animation: rgb-flow 2s linear infinite; }

        /* --- Modals --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2500; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-content { background: var(--modal-bg); width: 800px; max-width: 95%; border-radius: 20px; padding: 30px; border: 1px solid #45475a; box-shadow: 0 20px 60px rgba(0,0,0,0.6); display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #313244; padding-bottom: 15px; }
        .modal-title { font-size: 1.8rem; color: #fff; display: flex; gap: 15px; align-items: center; font-weight: bold; }
        .close-btn { background: none; border: none; color: #6c7086; font-size: 2rem; cursor: pointer; line-height: 1; }
        .close-btn:hover { color: #fff; }

        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; flex: 1; }
        .lib-badge { 
            background: #181825; border: 2px solid #313244; border-radius: 12px; 
            padding: 10px; display: flex; flex-direction: column; align-items: center; 
            text-align: center; transition: all 0.3s; opacity: 0.3; filter: grayscale(1);
        }
        .lib-badge.unlocked { 
            opacity: 1; filter: grayscale(0); border-color: var(--highlight-color); 
            background: linear-gradient(145deg, #1e1e2e, #252535); box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer;
        }
        .lib-badge .icon { font-size: 2rem; margin-bottom: 5px; }
        .lib-badge .name { font-size: 0.8rem; font-weight: bold; color: #fff; margin-bottom: 3px; }
        .lib-badge .desc { font-size: 0.6rem; color: #6c7086; line-height: 1.1; }

        /* Achievement Unlock & Detail Popups */
        #achievement-overlay, #detail-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-in { from{transform: scale(0.8); opacity: 0;} to{transform: scale(1); opacity: 1;} }
        
        .achievement-card { 
            background: #1e1e2e; padding: 30px 40px; border-radius: 20px; 
            border: 3px solid var(--highlight-color); text-align: center; 
            box-shadow: 0 0 40px rgba(249, 164, 80, 0.3); position: relative; z-index: 3002;
            transition: all 0.8s ease-in-out; max-width: 90%;
        }
        .achievement-icon { font-size: 4rem; display: block; margin-bottom: 15px; animation: bounce 1s infinite; }
        .achievement-title { font-size: 1.5rem; color: #fff; margin-bottom: 10px; font-weight: bold; }
        .achievement-desc { font-size: 1rem; color: #cdd6f4; line-height: 1.4; }
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3001; }

        /* Tables & Charts */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { text-align: left; color: #6c7086; padding: 12px; border-bottom: 1px solid #313244; }
        .history-table td { padding: 12px; color: #cdd6f4; border-bottom: 1px solid #313244; }
        .wpm-high { color: var(--correct-color); font-weight: bold; }
        #chart-container { width: 100%; height: 250px; background: #181825; border-radius: 8px; margin-bottom: 20px; position: relative; }
        canvas { width: 100%; height: 100%; }
        
        .chart-legend { display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; color: #6c7086; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        
        .view-toggle-btn { padding: 5px 15px; font-size: 0.9rem; background: #313244; color: #fff; border: 1px solid #45475a; border-radius: 4px; cursor: pointer; }
        .clear-btn { align-self: flex-end; padding: 8px 15px; background: #f38ba8; color: #1e1e2e; border: none; border-radius: 4px; cursor: pointer; }

        /* Main UI */
        .stats-bar { display: flex; gap: 40px; margin-bottom: 30px; font-size: 1.1rem; color: #6c7086; margin-top: 20px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .stat-value { color: #fff; font-weight: bold; font-size: 1.6rem; }
        .combo-container { transition: transform 0.2s; }
        .combo-container.high-combo { transform: scale(1.2); }
        .combo-value.fire { color: var(--fire-core); text-shadow: 0 0 15px var(--fire-outer); }

        .display-area { height: 140px; margin-bottom: 40px; background: #181825; padding: 0; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-wrap: nowrap; overflow: hidden; justify-content: flex-start; align-items: center; width: 80%; max-width: 900px; position: relative; mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%); -webkit-mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%); }
        #display-track { display: flex; padding: 0 50vw; transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1); align-items: flex-end; }
        .word-block { display: flex; flex-direction: column; align-items: center; margin-right: 30px; flex-shrink: 0; }
        .word-en { font-size: 2.8rem; letter-spacing: 2px; display: flex; }
        .word-zh { font-size: 1.2rem; color: var(--sub-text-color); margin-top: 10px; font-weight: normal; font-family: "Microsoft YaHei", sans-serif; opacity: 0.8; }
        .char { padding: 0 2px; border-radius: 4px; transition: all 0.1s; }
        .char.current { background: rgba(255,255,255,0.1); border-bottom: 4px solid var(--highlight-color); }
        .char.space-char { color: #585b70; min-width: 1rem; text-align: center; opacity: 1; } 
        .char.correct { color: var(--correct-color); }
        .char.wrong { color: var(--wrong-color); text-decoration: line-through; }

        .hands-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: visible; }
        .hand-svg { position: absolute; width: 240px; height: 280px; opacity: 0.9; transition: transform 0.15s cubic-bezier(0.22, 1, 0.36, 1); transform-origin: top left; }
        .hand-shape { fill: var(--hand-fill); stroke: var(--hand-stroke); stroke-width: 1.2; stroke-linejoin: round; stroke-linecap: round; }
        .hand-lines { fill: none; stroke: var(--hand-stroke); stroke-width: 0.8; opacity: 0.5; }
        .finger-tip { fill: #fff; opacity: 0; transition: opacity 0.1s; }
        .finger-tip.active { opacity: 1; filter: drop-shadow(0 0 3px #fff) drop-shadow(0 0 8px var(--highlight-color)) drop-shadow(0 0 12px var(--highlight-color)); }

        .keyboard { display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; justify-content: center; gap: 8px; }
        .key { width: 58px; height: 58px; background: var(--key-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; border-bottom: 5px solid var(--key-shadow); color: #a6adc8; transition: transform 0.05s, background 0.1s; position: relative; overflow: hidden; cursor: pointer; }
        /* ËûçÂêàÁΩ≤ÂêçÂà∞Á©∫Ê†ºÈîÆ */
        .key.space { 
            width: 380px; color: rgba(255,255,255,0.15); 
            font-size: 0.8rem; font-family: "Microsoft YaHei", sans-serif;
            display: flex; align-items: center; justify-content: center;
        }
        .key.active { transform: translateY(5px); border-bottom: 0px; background: var(--highlight-color); color: #1e1e2e; }
        /* ‰øùÊåÅÁ©∫Ê†ºÈîÆÈ´ò‰∫ÆÊó∂ÊñáÂ≠óÊ∑±Ëâ≤ */
        .key.space.active { color: rgba(0,0,0,0.4); } 
        .key.wrong-shake { animation: shake 0.3s; background: var(--wrong-color); color: #1e1e2e; }
        .key.tab, .key.caps, .key.shift, .key.enter, .key.backspace { font-size: 0.9rem; px: 10px; }
        .key.tab { width: 90px; align-items: flex-start; padding-left: 15px; }
        .key.caps { width: 100px; align-items: flex-start; padding-left: 15px; }
        .key.shift { width: 120px; } .key.enter { width: 110px; } .key.backspace { width: 100px; }
        
        body.on-fire { animation: danger-pulse 0.8s infinite alternate; }
        @keyframes danger-pulse { from { box-shadow: inset 0 0 50px rgba(243, 139, 168, 0.1); } to { box-shadow: inset 0 0 150px rgba(249, 226, 175, 0.3), inset 0 0 30px rgba(255, 0, 0, 0.2); } }
        .shake-screen { animation: shake-hard 0.2s ease-in-out; }
        @keyframes shake-hard { 0% { transform: translate(0,0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0,0); } }
        .particle { position: absolute; pointer-events: none; border-radius: 50%; z-index: 1000; mix-blend-mode: screen; }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-6px);} 75%{transform:translateX(6px);} }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--correct-color); color: #1e1e2e; padding: 10px 20px; border-radius: 20px; font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <button class="game-exit-btn" onclick="logout()">‚úï ÈÄÄÂá∫ÁôªÂΩï</button>

        <div id="login-screen">
            <h1 style="color:#fff; margin-bottom: 30px; font-size: 2.5rem;">Ë∞ÅÂú®ÁªÉ‰π†?</h1>
            <div id="user-grid" class="user-grid"></div>
            <div class="new-user-form">
                <input type="text" id="new-username" class="user-input" placeholder="ËæìÂÖ•ÂêçÂ≠ó..." maxlength="10">
                <button class="add-user-btn" onclick="createNewUser()">+ Êñ∞Âª∫Áî®Êà∑</button>
            </div>
        </div>

        <div id="start-screen">
            <h1 style="color:#fff; margin-bottom: 5px; font-size: 2rem;">ÊâìÂ≠óÁªÉ‰π†Â§ßÂ∏à</h1>
            <p id="welcome-text" class="welcome-text" style="margin-bottom:20px; color:var(--highlight-color);">Ê¨¢ËøéÂõûÊù•</p>
            
            <div class="section-title">ÊúÄÊñ∞ÂæΩÁ´†</div>
            <div class="recent-badges" id="recent-badges-container">
                </div>

            <div class="control-group">
                <select id="word-bank-select" class="word-select" onchange="handleBankChange()">
                    <option value="elementary">üìö Â∞èÂ≠¶ÂÖ®ËÉΩËØçÂ∫ì (200ËØç)</option>
                    <option value="python">üêç Python ÁºñÁ®ãËØçÂ∫ì</option>
                </select>
                
                <label for="custom-file-input" class="file-input-label">üìÇ ÂØºÂÖ•Ëá™ÂÆö‰πâ TXT</label>
                <input type="file" id="custom-file-input" accept=".txt" onchange="handleFileUpload(this)">
                <p id="file-status" style="color:var(--highlight-color); font-size:0.9rem; text-align:center; display:none;">Êñá‰ª∂Â∑≤Âä†ËΩΩ!</p>
            </div>

            <div class="btn-group">
                <button class="start-btn" onclick="startGame()">ÂºÄÂßãÁªÉ‰π†</button>
                <button class="action-btn" onclick="toggleModal('history-modal', true)">üìä Êä•Ë°®</button>
                <button class="action-btn" onclick="toggleModal('badge-modal', true)">üèÖ ÂæΩÁ´†Â∫ì</button>
            </div>
            <button class="logout-btn" onclick="logout()" style="margin-top:15px;">ÂàáÊç¢Áî®Êà∑</button>
        </div>

        <div id="achievement-overlay" onclick="closeAchievement()">
            <canvas id="fireworks-canvas"></canvas>
            <div class="achievement-card">
                <div class="achievement-icon" id="unlock-icon">üèÜ</div>
                <div class="achievement-title">Ëß£ÈîÅÊàêÂ∞±ÔºÅ</div>
                <div class="achievement-desc" id="unlock-desc">ÊÅ≠Âñú‰Ω†Ëé∑Âæó‰∫ÜÊñ∞ÁöÑÂæΩÁ´†</div>
                <div style="margin-top:20px; font-size:0.9rem; color:#6c7086;">ÁÇπÂáªÂ±èÂπïÁªßÁª≠</div>
            </div>
        </div>

        <div id="detail-overlay" onclick="closeDetailOverlay()">
            <div class="achievement-card" style="box-shadow: 0 0 30px var(--highlight-color); border-color: #45475a;">
                <div class="achievement-icon" id="detail-icon" style="animation:none; font-size: 3.5rem;"></div>
                <div class="achievement-title" id="detail-title"></div>
                <div class="achievement-desc" id="detail-desc"></div>
                <div style="margin-top:20px; font-size:0.8rem; color:#6c7086;">ÁÇπÂáªÂÖ≥Èó≠</div>
            </div>
        </div>

        <div id="history-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ÂéÜÂè≤ËÆ∞ÂΩï <button class="view-toggle-btn" onclick="toggleViewMode()">üìà ÂàáÊç¢ÂõæË°®</button></div>
                    <button class="close-btn" onclick="toggleModal('history-modal', false)">√ó</button>
                </div>
                <div id="history-list-view" style="max-height: 400px; overflow-y: auto;">
                    <table class="history-table"><thead><tr><th>Êó∂Èó¥</th><th>Â≠óÊï∞</th><th>ÈÄüÂ∫¶</th><th>ÂáÜÁ°ÆÁéá</th></tr></thead><tbody id="history-list"></tbody></table>
                </div>
                <div id="chart-container">
                    <canvas id="history-chart"></canvas>
                </div>
                <div class="chart-legend" id="chart-legend" style="display:none;">
                    <div class="legend-item"><div class="legend-dot" style="background:#f9a450"></div> WPM (ÈÄüÂ∫¶)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#a6e3a1"></div> ÂáÜÁ°ÆÁéá (%)</div>
                </div>

                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <span style="color:#6c7086; font-size:0.9rem;">* ‰øùÂ≠òÊúÄËøë50Êù°</span>
                    <button class="clear-btn" onclick="clearHistory()">Ê∏ÖÁ©∫ËÆ∞ÂΩï</button>
                </div>
            </div>
        </div>

        <div id="badge-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ÊàëÁöÑÂæΩÁ´†Â∫ì (<span id="badge-count">0/30</span>)</div>
                    <button class="close-btn" onclick="toggleModal('badge-modal', false)">√ó</button>
                </div>
                <div class="badge-grid" id="badge-library-grid">
                    </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item"><span class="stat-label">Êú¨Ê¨°ÁªÉ‰π†Êó∂Èó¥</span><span id="time-elapsed" class="stat-value">00:00</span></div>
            <div class="stat-item"><span class="stat-label">ÊâìÂ≠óÈÄüÂ∫¶ (WPM)</span><span id="wpm" class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">ÂáÜÁ°ÆÁéá</span><span id="accuracy" class="stat-value">100%</span></div>
            <div class="stat-item combo-container" id="combo-container"><span class="stat-label">ËøûÂáªÊï∞</span><span id="combo" class="stat-value combo-value">0</span></div>
        </div>

        <div class="display-area" id="display-container"><div id="display-track"></div></div>

        <div class="keyboard-container" id="keyboard-container">
            <div class="hands-layer">
                <svg id="hand-left" class="hand-svg" viewBox="0 0 240 280">
                    <path class="hand-shape" d="M70,280 L70,180 L50,165 Q30,150 25,130 L20,80 Q18,65 30,60 L45,65 L60,140 L65,140 L60,40 Q58,20 75,20 L90,25 L95,130 L100,130 L105,15 Q105,0 125,0 L140,10 L135,130 L140,130 L155,35 Q160,25 175,35 L180,50 L170,150 L190,175 Q215,195 220,220 L200,280 Z" />
                    <path class="hand-lines" d="M70,180 C90,170 120,165 160,175" /><path class="hand-lines" d="M60,140 C55,120 55,100 60,80" /><path class="hand-lines" d="M95,130 C90,110 90,90 95,70" /><path class="hand-lines" d="M135,130 C130,110 130,90 135,70" /><path class="hand-lines" d="M170,150 C175,130 180,110 175,90" /><path class="hand-lines" d="M190,175 C200,160 205,140 195,120" />
                    <circle class="finger-tip pinky" cx="32" cy="90" r="6" /><circle class="finger-tip ring" cx="75" cy="45" r="6" /><circle class="finger-tip middle" cx="122" cy="25" r="6" /><circle class="finger-tip index" cx="168" cy="60" r="6" /><circle class="finger-tip thumb" cx="205" cy="210" r="6" />
                </svg>
                <svg id="hand-right" class="hand-svg" viewBox="0 0 240 280" style="transform: scaleX(-1)">
                    <path class="hand-shape" d="M70,280 L70,180 L50,165 Q30,150 25,130 L20,80 Q18,65 30,60 L45,65 L60,140 L65,140 L60,40 Q58,20 75,20 L90,25 L95,130 L100,130 L105,15 Q105,0 125,0 L140,10 L135,130 L140,130 L155,35 Q160,25 175,35 L180,50 L170,150 L190,175 Q215,195 220,220 L200,280 Z" />
                    <path class="hand-lines" d="M70,180 C90,170 120,165 160,175" /><path class="hand-lines" d="M60,140 C55,120 55,100 60,80" /><path class="hand-lines" d="M95,130 C90,110 90,90 95,70" /><path class="hand-lines" d="M135,130 C130,110 130,90 135,70" /><path class="hand-lines" d="M170,150 C175,130 180,110 175,90" /><path class="hand-lines" d="M190,175 C200,160 205,140 195,120" />
                    <circle class="finger-tip pinky" cx="32" cy="90" r="6" /><circle class="finger-tip ring" cx="75" cy="45" r="6" /><circle class="finger-tip middle" cx="122" cy="25" r="6" /><circle class="finger-tip index" cx="168" cy="60" r="6" /><circle class="finger-tip thumb" cx="205" cy="210" r="6" />
                </svg>
            </div>
            <div class="keyboard">
                <div class="row"><div class="key tab" data-key="Tab">Tab</div><div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div><div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div><div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div><div class="key" data-key="p">P</div><div class="key" data-key="[">[</div><div class="key" data-key="]">]</div><div class="key backspace" data-key="Backspace">‚å´</div></div>
                <div class="row"><div class="key caps" data-key="CapsLock">Caps</div><div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div><div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div><div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div><div class="key" data-key=";">;</div><div class="key" data-key="'">'</div><div class="key enter" data-key="Enter">Enter</div></div>
                <div class="row"><div class="key shift" data-key="Shift">Shift</div><div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div><div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div><div class="key" data-key="m">M</div><div class="key" data-key=",">,</div><div class="key" data-key=".">.</div><div class="key" data-key="/">/</div><div class="key shift" data-key="Shift">Shift</div></div>
                <div class="row"><div class="key space" data-key=" ">ÁöÆÁöÆ&Âõ¢Âõ¢ÁöÑdaddyÂà∂‰Ωú</div></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò</div>

    <script>
        // üî¥ ËØ∑Â∞ÜÊ≠§Â§Ñ‰øÆÊîπ‰∏∫ÊÇ®Âú® 1Panel ÂàõÂª∫ÁöÑ API ÂüüÂêç (ÂøÖÈ°ªÊòØ https)
        const API_URL = "https://us.509992828.xyz:3005"; 

        const COMBO_THRESHOLD = 20;
        const USERS_KEY = 'typeMaster_users';
        let currentUser = null;
        let currentUserId = null;
        let userStats = null;

        const fingerCoords = { 'pinky': {x:32,y:90}, 'ring': {x:75,y:45}, 'middle': {x:122,y:25}, 'index': {x:168,y:60}, 'thumb': {x:205,y:210} };
        const keyMap = { 'q':{h:'L',f:'pinky'},'a':{h:'L',f:'pinky'},'z':{h:'L',f:'pinky'},'w':{h:'L',f:'ring'},'s':{h:'L',f:'ring'},'x':{h:'L',f:'ring'},'e':{h:'L',f:'middle'},'d':{h:'L',f:'middle'},'c':{h:'L',f:'middle'},'r':{h:'L',f:'index'},'f':{h:'L',f:'index'},'v':{h:'L',f:'index'},'t':{h:'L',f:'index'},'g':{h:'L',f:'index'},'b':{h:'L',f:'index'},'y':{h:'R',f:'index'},'h':{h:'R',f:'index'},'n':{h:'R',f:'index'},'u':{h:'R',f:'index'},'j':{h:'R',f:'index'},'m':{h:'R',f:'index'},'i':{h:'R',f:'middle'},'k':{h:'R',f:'middle'},',':{h:'R',f:'middle'},'o':{h:'R',f:'ring'},'l':{h:'R',f:'ring'},'.':{h:'R',f:'ring'},'p':{h:'R',f:'pinky'},';':{h:'R',f:'pinky'},'/':{h:'R',f:'pinky'},'[':{h:'R',f:'pinky'},']':{h:'R',f:'pinky'},"'":{h:'R',f:'pinky'},' ':{h:'R',f:'thumb'} };
        const wordBanks = { elementary: [{en:"apple",zh:"ËãπÊûú"},{en:"banana",zh:"È¶ôËïâ"},{en:"cat",zh:"Áå´"},{en:"dog",zh:"Áãó"},{en:"egg",zh:"È∏°Ëõã"},{en:"fish",zh:"È±º"},{en:"girl",zh:"Â•≥Â≠©"},{en:"boy",zh:"Áî∑Â≠©"},{en:"home",zh:"ÂÆ∂"},{en:"ice",zh:"ÂÜ∞"},{en:"juice",zh:"ÊûúÊ±Å"},{en:"kite",zh:"È£éÁ≠ù"},{en:"lion",zh:"ÁãÆÂ≠ê"},{en:"milk",zh:"ÁâõÂ•∂"},{en:"nose",zh:"ÈºªÂ≠ê"},{en:"orange",zh:"Ê©ôÂ≠ê"},{en:"pig",zh:"Áå™"},{en:"queen",zh:"Â•≥Áéã"},{en:"rabbit",zh:"ÂÖîÂ≠ê"},{en:"snake",zh:"Ëõá"},{en:"tiger",zh:"ËÄÅËôé"},{en:"umbrella",zh:"Èõ®‰ºû"},{en:"violin",zh:"Â∞èÊèêÁê¥"},{en:"water",zh:"Ê∞¥"},{en:"box",zh:"ÁõíÂ≠ê"},{en:"yellow",zh:"ÈªÑËâ≤"},{en:"red",zh:"Á∫¢Ëâ≤"},{en:"blue",zh:"ËìùËâ≤"},{en:"green",zh:"ÁªøËâ≤"},{en:"black",zh:"ÈªëËâ≤"},{en:"white",zh:"ÁôΩËâ≤"},{en:"zoo",zh:"Âä®Áâ©Âõ≠"},{en:"school",zh:"Â≠¶Ê†°"},{en:"book",zh:"‰π¶"},{en:"pen",zh:"Èí¢Á¨î"},{en:"pencil",zh:"ÈìÖÁ¨î"},{en:"desk",zh:"‰π¶Ê°å"},{en:"chair",zh:"Ê§ÖÂ≠ê"},{en:"teacher",zh:"ËÄÅÂ∏à"},{en:"student",zh:"Â≠¶Áîü"},{en:"father",zh:"Áà∂‰∫≤"},{en:"mother",zh:"ÊØç‰∫≤"},{en:"sister",zh:"ÂßêÂ¶π"},{en:"brother",zh:"ÂÖÑÂºü"},{en:"friend",zh:"ÊúãÂèã"},{en:"doctor",zh:"ÂåªÁîü"},{en:"nurse",zh:"Êä§Â£´"},{en:"driver",zh:"Âè∏Êú∫"},{en:"farmer",zh:"ÂÜúÊ∞ë"},{en:"cook",zh:"Âé®Â∏à"},{en:"happy",zh:"Âø´‰πê"},{en:"sad",zh:"ÊÇ≤‰º§"},{en:"hungry",zh:"È•ø"},{en:"thirsty",zh:"Ê∏¥"},{en:"tired",zh:"Á¥Ø"},{en:"good",zh:"Â•Ω"},{en:"bad",zh:"Âùè"},{en:"big",zh:"Â§ß"},{en:"small",zh:"Â∞è"},{en:"long",zh:"Èïø"},{en:"short",zh:"Áü≠"},{en:"new",zh:"Êñ∞"},{en:"old",zh:"Êóß"},{en:"young",zh:"Âπ¥ËΩª"},{en:"hot",zh:"ÁÉ≠"},{en:"cold",zh:"ÂÜ∑"},{en:"sunny",zh:"Êô¥Êúó"},{en:"rainy",zh:"‰∏ãÈõ®"},{en:"windy",zh:"ÂàÆÈ£é"},{en:"cloudy",zh:"Â§ö‰∫ë"},{en:"spring",zh:"Êò•Â§©"},{en:"summer",zh:"Â§èÂ§©"},{en:"autumn",zh:"ÁßãÂ§©"},{en:"winter",zh:"ÂÜ¨Â§©"},{en:"morning",zh:"Êó©‰∏ä"},{en:"afternoon",zh:"‰∏ãÂçà"},{en:"evening",zh:"Êôö‰∏ä"},{en:"night",zh:"Â§úÊôö"},{en:"today",zh:"‰ªäÂ§©"},{en:"tomorrow",zh:"ÊòéÂ§©"},{en:"one",zh:"‰∏Ä"},{en:"two",zh:"‰∫å"},{en:"three",zh:"‰∏â"},{en:"four",zh:"Âõõ"},{en:"five",zh:"‰∫î"},{en:"six",zh:"ÂÖ≠"},{en:"seven",zh:"‰∏É"},{en:"eight",zh:"ÂÖ´"},{en:"nine",zh:"‰πù"},{en:"ten",zh:"ÂçÅ"},{en:"run",zh:"Ë∑ë"},{en:"jump",zh:"Ë∑≥"},{en:"walk",zh:"Ëµ∞"},{en:"swim",zh:"Ê∏∏Ê≥≥"},{en:"fly",zh:"È£û"},{en:"sing",zh:"Âî±"},{en:"dance",zh:"Ë∑≥Ëàû"},{en:"read",zh:"ËØª"},{en:"write",zh:"ÂÜô"},{en:"draw",zh:"Áîª"},{en:"eat",zh:"ÂêÉ"},{en:"drink",zh:"Âñù"},{en:"sleep",zh:"Áù°Ëßâ"},{en:"play",zh:"Áé©"}], python: [{en:"print",zh:"ÊâìÂç∞ËæìÂá∫"},{en:"return",zh:"ËøîÂõû"},{en:"class",zh:"Á±ªÂÆö‰πâ"},{en:"def",zh:"ÂáΩÊï∞ÂÆö‰πâ"},{en:"if",zh:"Â¶ÇÊûú"},{en:"else",zh:"Âê¶Âàô"},{en:"elif",zh:"Âê¶ÂàôÂ¶ÇÊûú"},{en:"while",zh:"ÂΩì..Êó∂"},{en:"for",zh:"Âæ™ÁéØ"},{en:"in",zh:"Âú®..Èáå"},{en:"import",zh:"ÂØºÂÖ•"},{en:"from",zh:"‰ªé..ÂØºÂÖ•"},{en:"try",zh:"Â∞ùËØï"},{en:"except",zh:"ÊçïËé∑ÂºÇÂ∏∏"},{en:"raise",zh:"ÊäõÂá∫ÂºÇÂ∏∏"},{en:"finally",zh:"ÊúÄÁªàÊâßË°å"},{en:"with",zh:"‰∏ä‰∏ãÊñáÁÆ°ÁêÜ"},{en:"as",zh:"‰Ωú‰∏∫"},{en:"pass",zh:"Âç†‰ΩçÁ¨¶"},{en:"break",zh:"‰∏≠Êñ≠Âæ™ÁéØ"},{en:"continue",zh:"Ë∑≥ËøáÊú¨Ê¨°"},{en:"lambda",zh:"ÂåøÂêçÂáΩÊï∞"},{en:"global",zh:"ÂÖ®Â±ÄÂèòÈáè"},{en:"nonlocal",zh:"ÈùûÂ±ÄÈÉ®"},{en:"True",zh:"Áúü"},{en:"False",zh:"ÂÅá"},{en:"None",zh:"Á©∫ÂÄº"},{en:"and",zh:"ÈÄªËæë‰∏é"},{en:"or",zh:"ÈÄªËæëÊàñ"},{en:"not",zh:"ÈÄªËæëÈùû"},{en:"is",zh:"ÊòØ(ÂØπË±°)"},{en:"list",zh:"ÂàóË°®"},{en:"dict",zh:"Â≠óÂÖ∏"},{en:"set",zh:"ÈõÜÂêà"},{en:"tuple",zh:"ÂÖÉÁªÑ"},{en:"float",zh:"ÊµÆÁÇπÊï∞"},{en:"string",zh:"Â≠óÁ¨¶‰∏≤"},{en:"range",zh:"ËåÉÂõ¥"},{en:"len",zh:"ÈïøÂ∫¶"},{en:"open",zh:"ÊâìÂºÄÊñá‰ª∂"}] };

        let currentWordsData=[], currentTextStr="", currentIndex=0, totalKeys=0, correctKeys=0, combo=0, startTime=null, audioCtx=null;
        let sessionStartTime=null, timerInterval=null, allCharElements=[], isChartView=false, useCustomFile=false, customWordsData=[];
        
        const achievements = [
            { id: '1', icon: 'üèÜ', name: 'ÂàùÂá∫ËåÖÂ∫ê', desc: 'ÂÆåÊàêÁ¨¨1Ê¨°ÁªÉ‰π†', check: s => s.totalRounds >= 1 },
            { id: '2', icon: 'üå±', name: 'Ê∏êÂÖ•‰Ω≥Â¢É', desc: 'ÂÆåÊàê10Ê¨°ÁªÉ‰π†', check: s => s.totalRounds >= 10 },
            { id: '3', icon: 'üå≤', name: 'ÁÜüËÉΩÁîüÂ∑ß', desc: 'ÂÆåÊàê50Ê¨°ÁªÉ‰π†', check: s => s.totalRounds >= 50 },
            { id: '4', icon: 'üëë', name: 'ÈîÆÁõò‰πãÁéã', desc: 'ÂÆåÊàê100Ê¨°ÁªÉ‰π†', check: s => s.totalRounds >= 100 },
            { id: '5', icon: '‚ö°Ô∏è', name: 'Èó™Áîµ‰æ†', desc: 'ÈÄüÂ∫¶Ë∂ÖËøá 40 WPM', check: s => s.lastWpm > 40 },
            { id: '6', icon: 'üöÄ', name: 'Ë∂ÖÈü≥ÈÄü', desc: 'ÈÄüÂ∫¶Ë∂ÖËøá 60 WPM', check: s => s.lastWpm > 60 },
            { id: '7', icon: 'üõ∏', name: 'ÂÖâÈÄüÊåáÊ≥ï', desc: 'ÈÄüÂ∫¶Ë∂ÖËøá 80 WPM', check: s => s.lastWpm > 80 },
            { id: '8', icon: 'üåå', name: 'Êó∂Á©∫Á©øÊ¢≠', desc: 'ÈÄüÂ∫¶Ë∂ÖËøá 100 WPM', check: s => s.lastWpm > 100 },
            { id: '9', icon: 'üëΩ', name: 'Â§ñÊòüÊâãÈÄü', desc: 'ÈÄüÂ∫¶Ë∂ÖËøá 120 WPM', check: s => s.lastWpm > 120 },
            { id: '10', icon: 'üéØ', name: 'Á•ûÂ∞ÑÊâã', desc: 'ÂáÜÁ°ÆÁéá 100% ÂÆåÊàê‰∏ÄËΩÆ', check: s => s.lastAcc === 100 && s.roundKeys > 10 },
            { id: '11', icon: 'üíé', name: 'ÂÆåÁæé‰∏ª‰πâ', desc: 'Á¥ØËÆ°10Ê¨°ÂÆåÁæéÂõûÂêà', check: s => s.totalPerfectRounds >= 10 },
            { id: '12', icon: 'üî¨', name: 'Èõ∂Â§±ËØØÂ§ßÂ∏à', desc: 'Á¥ØËÆ°50Ê¨°ÂÆåÁæéÂõûÂêà', check: s => s.totalPerfectRounds >= 50 },
            { id: '13', icon: 'üî•', name: 'ÁÅ´ÂäõÂÖ®ÂºÄ', desc: 'ÂçïÊ¨°ËøûÂáªË∂ÖËøá 50', check: s => s.maxCombo >= 50 },
            { id: '14', icon: 'üåã', name: 'ÂøÉÊµÅÁä∂ÊÄÅ', desc: 'ÂçïÊ¨°ËøûÂáªË∂ÖËøá 100', check: s => s.maxCombo >= 100 },
            { id: '15', icon: 'üå™Ô∏è', name: 'Êö¥È£éÈ™§Èõ®', desc: 'ÂçïÊ¨°ËøûÂáªË∂ÖËøá 200', check: s => s.maxCombo >= 200 },
            { id: '16', icon: '‚ö°Ô∏è', name: 'ËøûÂáª‰πãÁ•û', desc: 'ÂçïÊ¨°ËøûÂáªË∂ÖËøá 500', check: s => s.maxCombo >= 500 },
            { id: '17', icon: 'üìú', name: 'Â≠¶Á´•', desc: 'Á¥ØËÆ°ËæìÂÖ• 500 ‰∏™ÂçïËØç', check: s => s.totalWords >= 500 },
            { id: '18', icon: 'üìö', name: 'Â≠¶ËÄÖ', desc: 'Á¥ØËÆ°ËæìÂÖ• 2000 ‰∏™ÂçïËØç', check: s => s.totalWords >= 2000 },
            { id: '19', icon: 'üßô‚Äç‚ôÇÔ∏è', name: 'Â§ßË¥§ËÄÖ', desc: 'Á¥ØËÆ°ËæìÂÖ• 10000 ‰∏™ÂçïËØç', check: s => s.totalWords >= 10000 },
            { id: '20', icon: 'üìñ', name: '‰º†Â•á', desc: 'Á¥ØËÆ°ËæìÂÖ• 50000 ‰∏™ÂçïËØç', check: s => s.totalWords >= 50000 },
            { id: '21', icon: 'üïí', name: 'Âã§Â•ã‰πãÊòü', desc: 'Á¥ØËÆ°ÁªÉ‰π†Ë∂ÖËøá 1 Â∞èÊó∂', check: s => s.totalTime >= 3600 },
            { id: '22', icon: 'üèÉ‚Äç‚ôÇÔ∏è', name: 'È©¨ÊãâÊùæ', desc: 'Á¥ØËÆ°ÁªÉ‰π†Ë∂ÖËøá 5 Â∞èÊó∂', check: s => s.totalTime >= 18000 },
            { id: '23', icon: 'üèãÔ∏è‚Äç‚ôÇÔ∏è', name: 'Èí¢ÈìÅÊÑèÂøó', desc: 'Á¥ØËÆ°ÁªÉ‰π†Ë∂ÖËøá 10 Â∞èÊó∂', check: s => s.totalTime >= 36000 },
            { id: '24', icon: 'üßò‚Äç‚ôÇÔ∏è', name: 'Á¶ÖÂÆö', desc: 'Á¥ØËÆ°ÁªÉ‰π†Ë∂ÖËøá 24 Â∞èÊó∂', check: s => s.totalTime >= 86400 },
            { id: '25', icon: 'ü¶â', name: 'Â§úÁå´Â≠ê', desc: 'Âú®Êôö‰∏ä 10 ÁÇπÂêéÁªÉ‰π†', check: s => new Date().getHours() >= 22 },
            { id: '26', icon: '‚òÄÔ∏è', name: 'Êó©Ëµ∑ÁöÑÈ∏üÂÑø', desc: 'Âú®Êó©‰∏ä 5-8 ÁÇπÁªÉ‰π†', check: s => { const h=new Date().getHours(); return h>=5 && h<=8; } },
            { id: '27', icon: 'üìÖ', name: 'Âë®Êú´ÊàòÂ£´', desc: 'Âú®Âë®ÂÖ≠ÊàñÂë®Êó•ÁªÉ‰π†', check: s => { const d=new Date().getDay(); return d===0 || d===6; } },
            { id: '28', icon: 'üê¢', name: 'ÊÖ¢ÂêûÂêû', desc: 'WPM‰Ωé‰∫é10‰ΩÜÂùöÊåÅÂÆåÊàê', check: s => s.lastWpm < 10 && s.lastWpm > 0 },
            { id: '29', icon: 'üî®', name: 'ÈîÆÂ∏ΩÁ†¥ÂùèËÄÖ', desc: 'Á¥ØËÆ°ÊåâÈîÆ 10,000 Ê¨°', check: s => s.totalKeystrokes >= 10000 },
            { id: '30', icon: 'üéπ', name: 'Èí¢Áê¥ÂÆ∂', desc: 'Á¥ØËÆ°ÊåâÈîÆ 50,000 Ê¨°', check: s => s.totalKeystrokes >= 50000 }
        ];

        const displayContainer = document.getElementById('display-container');
        const displayTrack = document.getElementById('display-track');
        const keyboardContainer = document.getElementById('keyboard-container');
        const handLeft = document.getElementById('hand-left');
        const handRight = document.getElementById('hand-right');
        const appWrapper = document.getElementById('app-wrapper'); 

        // --- User Management ---
        function getUsers() { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
        function saveUsers(users) { localStorage.setItem(USERS_KEY, JSON.stringify(users)); }
        
        function renderUserList() {
            const grid = document.getElementById('user-grid'); grid.innerHTML = '';
            const users = getUsers();
            if (users.length === 0) return;
            users.forEach(name => {
                const card = document.createElement('div'); card.className='user-card';
                card.onclick = () => loginUser(name);
                card.innerHTML = `<div class="user-avatar">üë§</div><div class="user-name">${name}</div>`;
                grid.appendChild(card);
            });
        }

        function createNewUser() {
            const input = document.getElementById('new-username'); const name = input.value.trim();
            if (!name) return alert("ËØ∑ËæìÂÖ•ÂêçÂ≠ó");
            const users = getUsers(); if (users.includes(name)) return alert("Áî®Êà∑Â∑≤Â≠òÂú®");
            users.push(name); saveUsers(users); input.value = ''; renderUserList();
        }

        async function loginUser(name) {
            try {
                const res = await fetch(`${API_URL}/api/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                const data = await res.json();
                
                currentUser = data.user.name; currentUserId = data.user.id;
                userStats = data.stats;
                if (typeof userStats.unlocked_badges === 'string') userStats.unlocked = JSON.parse(userStats.unlocked_badges || '[]');
                else userStats.unlocked = userStats.unlocked_badges || [];
                
                userStats.totalRounds = userStats.totalRounds || 0;
                userStats.totalWords = userStats.totalWords || 0;
                userStats.maxCombo = userStats.maxCombo || 0;
                userStats.totalPerfectRounds = userStats.totalPerfectRounds || 0;
                userStats.totalKeystrokes = userStats.totalKeystrokes || 0;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('start-screen').style.display = 'flex';
                document.getElementById('welcome-text').innerText = `Ê¨¢ËøéÂõûÊù•, ${currentUser}`;
                renderRecentBadges();
                loadServerHistory();
            } catch (e) {
                alert("ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÂêéÁ´ØÈÖçÁΩÆ");
                console.error(e);
            }
        }

        async function loadServerHistory() {
            if(!currentUserId) return;
            const res = await fetch(`${API_URL}/api/history/${currentUserId}`);
            const history = await res.json();
            localStorage.setItem('tempServerHistory', JSON.stringify(history));
        }

        function logout() {
            currentUser = null; currentUserId = null;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }

        // Init Users
        renderUserList();

        function handleBankChange() { useCustomFile=false; document.getElementById('file-status').style.display='none'; }
        function handleFileUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== '');
                customWordsData = lines.map(line => {
                    const parts = line.split('|');
                    if (parts.length > 1) return { en: parts[0].trim(), zh: parts[1].trim() };
                    const spaces = line.trim().split(/\s+/);
                    if (spaces.length > 1 && /[\u4e00-\u9fa5]/.test(spaces[spaces.length-1])) { const zh=spaces.pop(); const en=spaces.join(' '); return {en,zh}; }
                    return { en: line.trim(), zh: "Ëá™ÂÆö‰πâÁªÉ‰π†" };
                });
                useCustomFile=true; document.getElementById('file-status').innerText=`Â∑≤Âä†ËΩΩ ${customWordsData.length} ‰∏™ÂçïËØç`; document.getElementById('file-status').style.display='block'; document.getElementById('word-bank-select').value=''; 
            }; reader.readAsText(file);
        }

        function startGame() { 
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} 
            if (useCustomFile && customWordsData.length > 0) currentWordsData = customWordsData;
            else { const s = document.getElementById('word-bank-select').value; if(!s) return alert("ËØ∑ÈÄâÊã©ËØçÂ∫ìÊàñÂØºÂÖ•Êñá‰ª∂"); currentWordsData = wordBanks[s]; }
            startSessionTimer(); document.getElementById('start-screen').style.display='none'; initRound(); 
        }

        function startSessionTimer() {
            sessionStartTime = Date.now(); if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - sessionStartTime) / 1000);
                document.getElementById('time-elapsed').innerText = `${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`;
                userStats.totalTime += 1;
                checkAchievements({ totalTime: userStats.totalTime });
                localStorage.setItem('typeMasterStats', JSON.stringify(userStats));
            }, 1000);
        }
        
        function initRound() { 
            let selection = []; const count = Math.min(20, currentWordsData.length);
            for(let i=0; i<count; i++) selection.push(currentWordsData[Math.floor(Math.random() * currentWordsData.length)]);
            renderBilingualText(selection); currentTextStr = selection.map(w => w.en).join(" "); currentIndex = 0; autoScroll(); setTimeout(updateHandsPosition, 50); 
        }

        function renderBilingualText(wordsArray) {
            displayTrack.innerHTML = ''; allCharElements = []; 
            wordsArray.forEach((wordObj, wordIndex) => {
                const b = document.createElement('div'); b.className='word-block';
                const e = document.createElement('div'); e.className='word-en';
                wordObj.en.split('').forEach(char => { const s=document.createElement('span'); s.innerText=char; s.className='char'; e.appendChild(s); allCharElements.push(s); });
                if (wordIndex < wordsArray.length - 1) { const s=document.createElement('span'); s.innerText='‚ê£'; s.className='char space-char'; e.appendChild(s); allCharElements.push(s); }
                const z = document.createElement('div'); z.className='word-zh'; z.innerText=wordObj.zh;
                b.appendChild(e); b.appendChild(z); displayTrack.appendChild(b);
            });
            if(allCharElements.length > 0) allCharElements[0].classList.add('current');
        }

        function autoScroll() {
            const el = allCharElements[currentIndex]; if (el) {
                const rect = el.getBoundingClientRect(); const conRect = displayContainer.getBoundingClientRect();
                const diff = (conRect.left + conRect.width/2) - (rect.left + rect.width/2);
                const currentT = new WebKitCSSMatrix(window.getComputedStyle(displayTrack).transform).m41;
                displayTrack.style.transform = `translateX(${currentT + diff}px)`;
            }
        }

        function updateHandsPosition() {
            document.querySelectorAll('.finger-tip').forEach(el => el.classList.remove('active'));
            let tL=null, fL='index', tR=null, fR='index';
            if (currentIndex < currentTextStr.length) {
                const char = currentTextStr[currentIndex].toLowerCase(); const map = keyMap[char];
                if (map) {
                    const tEl = document.querySelector(`.key[data-key="${char}"]`) || document.querySelector(`.key[data-key=" "]`);
                    if (tEl) { if (map.h === 'L') { tL=tEl; fL=map.f; } else { tR=tEl; fR=map.f; } }
                    const h = map.h === 'L' ? handLeft : handRight; const f = h.querySelector(`.finger-tip.${map.f}`); if(f) f.classList.add('active');
                }
            }
            moveHand(handLeft, tL || document.querySelector('.key[data-key="f"]'), fL, false); 
            moveHand(handRight, tR || document.querySelector('.key[data-key="j"]'), fR, true);
        }

        function moveHand(handEl, keyEl, fingerType, isRightHand) {
            const cRect = keyboardContainer.getBoundingClientRect(); const kRect = keyEl.getBoundingClientRect();
            const cx = kRect.left - cRect.left + kRect.width/2; const cy = kRect.top - cRect.top + kRect.height/2;
            const loc = fingerCoords[fingerType];
            const ty = cy + 13; const fy = ty - loc.y; let fx = isRightHand ? cx + loc.x : cx - loc.x;
            handEl.style.transform = `translate(${fx}px, ${fy}px) ${isRightHand?'scaleX(-1)':''}`;
        }

        function triggerRipple(keyEl) {
            const ripple = document.createElement('div'); ripple.className = 'key-ripple';
            const rect = keyEl.getBoundingClientRect();
            ripple.style.left = (rect.left + rect.width/2) + 'px';
            ripple.style.top = (rect.top + rect.height/2) + 'px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        function spawnFireParticles(x, y) {
            for(let i=0; i<20; i++) {
                const p = document.createElement('div'); p.classList.add('particle'); document.body.appendChild(p);
                const size = Math.random()*8+4; p.style.width=size+'px'; p.style.height=size+'px';
                p.style.background = Math.random()>0.7?'#fff':(Math.random()>0.3?'#f9e2af':'#f38ba8');
                p.style.left=x+'px'; p.style.top=y+'px';
                const a = Math.random()*Math.PI*2; const v = Math.random()*150+50;
                const anim = p.animate([{transform:'translate(0,0) scale(1)', opacity:1}, {transform:`translate(${Math.cos(a)*v}px, ${Math.sin(a)*v}px) scale(0)`, opacity:0}], {duration:Math.random()*600+400, easing:'cubic-bezier(0,.5,.5,1)'});
                anim.onfinish=()=>p.remove();
            }
        }

        function checkAchievements(currentStats) {
            let newlyUnlocked = false;
            achievements.forEach(ach => {
                if (!userStats.unlocked.includes(ach.id)) {
                    const checkData = { ...userStats, ...currentStats };
                    if (ach.check(checkData)) {
                        userStats.unlocked.push(ach.id);
                        showUnlock(ach);
                        newlyUnlocked = true;
                    }
                }
            });
            if (newlyUnlocked) {
                fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: currentUserId, record: {wpm:0,acc:'0',count:0,time:''}, stats: {...userStats, unlocked: userStats.unlocked} })
                });
                renderRecentBadges();
            }
        }

        function renderRecentBadges() {
            const container = document.getElementById('recent-badges-container'); container.innerHTML = '';
            const last5Ids = userStats.unlocked.slice(-5).reverse();
            if (last5Ids.length === 0) {
                for(let i=0; i<3; i++) { const el = document.createElement('div'); el.className = 'mini-badge empty'; el.innerText = '?'; container.appendChild(el); }
            } else {
                last5Ids.forEach(id => {
                    const ach = achievements.find(a => a.id === id);
                    if (ach) {
                        const el = document.createElement('div'); el.className = 'mini-badge';
                        el.onclick = () => showDetailOverlay(ach);
                        el.innerHTML = `${ach.icon}<div class="tooltip">${ach.name}</div>`;
                        container.appendChild(el);
                    }
                });
            }
        }

        function renderBadgeLibrary() {
            const container = document.getElementById('badge-library-grid');
            const countEl = document.getElementById('badge-count');
            container.innerHTML = ''; countEl.innerText = `${userStats.unlocked.length}/${achievements.length}`;
            achievements.forEach(ach => {
                const isUnlocked = userStats.unlocked.includes(ach.id);
                const el = document.createElement('div');
                el.className = `lib-badge ${isUnlocked ? 'unlocked' : ''}`;
                if(isUnlocked) el.onclick = () => showDetailOverlay(ach);
                el.innerHTML = `<div class="icon">${isUnlocked ? ach.icon : 'üîí'}</div><div class="name">${ach.name}</div><div class="desc">${ach.desc}</div>`;
                container.appendChild(el);
            });
        }

        function showUnlock(ach) {
            const overlay = document.getElementById('achievement-overlay');
            document.getElementById('unlock-icon').innerText = ach.icon;
            document.getElementById('unlock-desc').innerText = `ÊÅ≠ÂñúËß£ÈîÅÔºö${ach.name}`;
            overlay.style.display = 'flex';
            startFireworks(); playSound('epic'); 
            setTimeout(() => {
                const card = overlay.querySelector('.achievement-card');
                card.style.transform = 'translateY(-100vh) scale(0.1)'; card.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; card.style.transform = ''; card.style.opacity = ''; stopFireworks(); }, 800); 
            }, 1500); 
        }

        function showDetailOverlay(ach) {
            document.getElementById('detail-icon').innerText = ach.icon;
            document.getElementById('detail-title').innerText = ach.name;
            document.getElementById('detail-desc').innerText = ach.desc;
            document.getElementById('detail-overlay').style.display = 'flex';
        }
        function closeDetailOverlay() { document.getElementById('detail-overlay').style.display = 'none'; }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
            if (id === 'badge-modal' && show) renderBadgeLibrary();
            if (id === 'history-modal' && show) { isChartView=false; renderHistoryList(); document.getElementById('history-list-view').style.display='block'; document.getElementById('chart-container').style.display='none'; }
        }

        function closeAchievement() { const overlay = document.getElementById('achievement-overlay'); overlay.style.display = 'none'; stopFireworks(); }

        let fwCtx, fwW, fwH, fwLoop; let fireworks = [];
        function startFireworks() {
            const c = document.getElementById('fireworks-canvas'); fwCtx = c.getContext('2d'); fwW = c.width = window.innerWidth; fwH = c.height = window.innerHeight; fireworks = [];
            function loop() {
                fwCtx.globalCompositeOperation = 'destination-out'; fwCtx.fillStyle = 'rgba(0, 0, 0, 0.1)'; fwCtx.fillRect(0, 0, fwW, fwH);
                fwCtx.globalCompositeOperation = 'lighter';
                if (Math.random() < 0.05) fireworks.push(new Firework());
                for (let i = fireworks.length - 1; i >= 0; i--) { fireworks[i].update(); fireworks[i].draw(); if (fireworks[i].dead) fireworks.splice(i, 1); }
                fwLoop = requestAnimationFrame(loop);
            } loop();
        }
        function stopFireworks() { cancelAnimationFrame(fwLoop); fwCtx.clearRect(0,0,fwW,fwH); }
        class Firework {
            constructor() { this.x = Math.random() * fwW; this.y = fwH; this.tx = Math.random() * fwW; this.ty = Math.random() * fwH / 2; this.vx = (this.tx - this.x) / 100; this.vy = (this.ty - this.y) / 100; this.age = 0; this.exploded = false; this.particles = []; this.color = `hsl(${Math.random()*360}, 100%, 50%)`; }
            update() { if(!this.exploded) { this.x += this.vx; this.y += this.vy; this.age++; if(this.age >= 100) { this.exploded = true; this.explode(); } } else { for(let p of this.particles) { p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.alpha-=0.01; } this.particles = this.particles.filter(p=>p.alpha>0); if(this.particles.length===0) this.dead=true; } }
            explode() { for(let i=0; i<50; i++) { const a = Math.random()*Math.PI*2; const v = Math.random()*3; this.particles.push({x:this.x, y:this.y, vx:Math.cos(a)*v, vy:Math.sin(a)*v, alpha:1}); } }
            draw() { if(!this.exploded) { fwCtx.fillStyle = this.color; fwCtx.fillRect(this.x, this.y, 3, 3); } else { for(let p of this.particles) { fwCtx.fillStyle = this.color; fwCtx.globalAlpha = p.alpha; fwCtx.fillRect(p.x, p.y, 2, 2); } fwCtx.globalAlpha = 1; } }
        }

        function playSound(type) {
            if(!audioCtx || audioCtx.state === 'suspended') return;
            const t = audioCtx.currentTime;
            if(type === 'click') {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                const n = audioCtx.createBufferSource(); n.buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*0.05, audioCtx.sampleRate);
                const d = n.buffer.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const f = audioCtx.createBiquadFilter(); f.type="highpass"; f.frequency.value=1000;
                o.frequency.setValueAtTime(300, t); o.frequency.exponentialRampToValueAtTime(50, t+0.05);
                g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05);
                n.connect(f); f.connect(g); o.connect(g); g.connect(audioCtx.destination); o.start(); n.start(); o.stop(t+0.05); n.stop(t+0.05);
            } else if (type === 'epic') {
                [261.63, 329.63, 392.00, 523.25].forEach((freq, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.type = i%2 ? 'sawtooth' : 'square'; o.frequency.setValueAtTime(freq, t);
                    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    const f = audioCtx.createBiquadFilter(); f.type = "lowpass"; f.frequency.setValueAtTime(200, t); f.frequency.linearRampToValueAtTime(2000, t + 0.2);
                    o.connect(f); f.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t + 0.6);
                });
            } else {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.type = 'triangle'; o.frequency.setValueAtTime(100, t); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0.01, t + 0.15);
                o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(t+0.15);
            }
        }
        function speakWord(text) { if (!window.speechSynthesis) return; if (!/[a-zA-Z]/.test(text)) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.8; u.pitch = 1.1; window.speechSynthesis.speak(u); }

        function saveHistory() {
            const wpm = parseInt(document.getElementById('wpm').innerText);
            const acc = parseInt(document.getElementById('accuracy').innerText.replace('%',''));
            const time = new Date().toLocaleString('zh-CN', { hour12: false });
            
            userStats.totalRounds += 1;
            userStats.totalWords += 20; 
            if (acc === 100) userStats.totalPerfectRounds += 1;
            if (combo > userStats.maxCombo) userStats.maxCombo = combo;

            checkAchievements({ lastWpm: wpm, lastAcc: acc, roundKeys: correctKeys });

            fetch(`${API_URL}/api/save`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: currentUserId,
                    record: { wpm, acc: acc+'%', count: correctKeys, time, timestamp: time }, // Fix: Added timestamp key explicitly
                    stats: { ...userStats, unlocked: userStats.unlocked }
                })
            }).then(() => {
                document.getElementById('toast').classList.add('show'); 
                setTimeout(()=>document.getElementById('toast').classList.remove('show'), 2000);
                loadServerHistory();
            });
        }

        function toggleViewMode() { isChartView=!isChartView; const l=document.getElementById('history-list-view'), c=document.getElementById('chart-container'); if(isChartView){l.style.display='none';c.style.display='block';renderHistoryChart();}else{l.style.display='block';c.style.display='none';renderHistoryList();} }
        function renderHistoryList() { const h=JSON.parse(localStorage.getItem('tempServerHistory')||'[]'); const l=document.getElementById('history-list'); l.innerHTML=h.length===0?'<tr><td colspan="4" style="text-align:center;color:#6c7086;">ÊöÇÊó†ËÆ∞ÂΩï</td></tr>':''; h.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.timestamp || r.time}</td><td>${r.count}</td><td class="${parseInt(r.wpm)>40?'wpm-high':''}">${r.wpm}</td><td>${r.acc}</td>`;l.appendChild(tr);}); }
        
        function renderHistoryChart() { 
            const canvas = document.getElementById('history-chart'); const ctx = canvas.getContext('2d');
            const h = JSON.parse(localStorage.getItem('tempServerHistory')||'[]');
            const r = canvas.parentNode.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height;
            
            if(!document.getElementById('chart-legend')) {
                const legend = document.createElement('div'); legend.id='chart-legend'; legend.className='chart-legend';
                legend.innerHTML='<div class="legend-item"><div class="legend-dot" style="background:#f9a450"></div> WPM (ÈÄüÂ∫¶)</div><div class="legend-item"><div class="legend-dot" style="background:#a6e3a1"></div> ÂáÜÁ°ÆÁéá (%)</div>';
                document.getElementById('chart-container').appendChild(legend);
            }

            if(h.length<2) { ctx.fillStyle="#6c7086"; ctx.font="16px monospace"; ctx.textAlign="center"; ctx.fillText("ÈúÄÊõ¥Â§öËÆ∞ÂΩïÊòæÁ§∫Ë∂ãÂäø", canvas.width/2, canvas.height/2); return; }
            const d = h.slice().reverse(); const p=30; const w=canvas.width-p*2; const ht=canvas.height-p*2;
            ctx.strokeStyle="#313244"; ctx.beginPath(); ctx.moveTo(p,p); ctx.lineTo(p,canvas.height-p); ctx.lineTo(canvas.width-p,canvas.height-p); ctx.stroke();
            let max=100; d.forEach(x=>{if(parseInt(x.wpm)>max)max=parseInt(x.wpm)}); max+=10;
            const getX = i => p + (i/(d.length-1))*w; const getY = v => (canvas.height-p) - (v/max)*ht;
            
            const points = [];
            const draw = (k,c) => { 
                ctx.strokeStyle=c; ctx.lineWidth=2; ctx.beginPath(); 
                d.forEach((x,i)=>{ 
                    const v=parseInt(x[k]); const px=getX(i), py=getY(v); 
                    if(i===0)ctx.moveTo(px,py); else ctx.lineTo(px,py); 
                    ctx.fillStyle=c; ctx.fillRect(px-2,py-2,4,4);
                    if(!points[i]) points[i] = {x:px, data:x}; points[i][k] = v;
                }); 
                ctx.stroke(); 
            };
            draw('wpm','#f9a450'); draw('acc','#a6e3a1');

            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left;
                let closest = null; let minDist = 1000;
                points.forEach(p => { const dist = Math.abs(p.x - mouseX); if(dist < minDist) { minDist = dist; closest = p; } });
                
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.strokeStyle="#313244"; ctx.beginPath(); ctx.moveTo(p,p); ctx.lineTo(p,canvas.height-p); ctx.lineTo(canvas.width-p,canvas.height-p); ctx.stroke();
                draw('wpm','#f9a450'); draw('acc','#a6e3a1');

                if(closest && minDist < 50) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth=1;
                    ctx.beginPath(); ctx.moveTo(closest.x, p); ctx.lineTo(closest.x, canvas.height-p); ctx.stroke();
                    const tx = closest.x - 60 < 0 ? closest.x + 10 : closest.x - 60; const ty = 10;
                    ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(tx, ty, 120, 60);
                    ctx.strokeStyle = "#45475a"; ctx.strokeRect(tx, ty, 120, 60);
                    ctx.fillStyle = "#fff"; ctx.font = "12px sans-serif"; ctx.textAlign = "left";
                    ctx.fillText(`WPM: ${closest.wpm}`, tx+10, ty+20);
                    ctx.fillText(`ACC: ${closest.acc}%`, tx+10, ty+35);
                    ctx.fillStyle = "#6c7086"; ctx.font = "10px sans-serif";
                    ctx.fillText(`${closest.data.timestamp || closest.data.time}`, tx+10, ty+50);
                }
            };
            canvas.onmouseleave = () => {
                 ctx.clearRect(0,0,canvas.width,canvas.height);
                 ctx.strokeStyle="#313244"; ctx.beginPath(); ctx.moveTo(p,p); ctx.lineTo(p,canvas.height-p); ctx.lineTo(canvas.width-p,canvas.height-p); ctx.stroke();
                 draw('wpm','#f9a450'); draw('acc','#a6e3a1');
            }
        }
        function clearHistory() { if(confirm('Ê∏ÖÁ©∫ÊâÄÊúâÔºü')) { /* API call to clear */ } }

        function handleVirtualKey(keyVal) { const dummyEvent = { key: keyVal, preventDefault: () => {} }; processInput(dummyEvent); }
        document.querySelectorAll('.key').forEach(k => {
            k.addEventListener('touchstart', (e) => { e.preventDefault(); const keyVal = k.getAttribute('data-key'); handleVirtualKey(keyVal); });
            k.addEventListener('mousedown', (e) => { e.preventDefault(); const keyVal = k.getAttribute('data-key'); handleVirtualKey(keyVal); });
        });

        function processInput(e) {
            if(document.getElementById('start-screen').style.display !== 'none') return;
            if(['Shift','Alt','Control','Meta','CapsLock','Tab'].includes(e.key)) return;
            if(!startTime) startTime = Date.now();
            const rawKey = e.key; const key = rawKey.length === 1 ? rawKey.toLowerCase() : rawKey;
            const targetChar = currentTextStr[currentIndex]?.toLowerCase();
            const visualKey = document.querySelector(`.key[data-key="${rawKey.length===1?key:rawKey}"]`) || document.querySelector(`.key[data-key="${rawKey}"]`);
            if (visualKey) { visualKey.classList.add('active'); setTimeout(()=>visualKey.classList.remove('active'), 100); triggerRipple(visualKey); }
            if(key === 'Backspace') { 
                if(currentIndex > 0) { 
                    currentIndex--; const prev = allCharElements[currentIndex];
                    prev.className = 'char ' + (currentTextStr[currentIndex] === ' ' ? 'space-char' : '') + ' current';
                    const curr = allCharElements[currentIndex + 1]; if(curr) curr.classList.remove('current');
                    updateHandsPosition(); autoScroll(); 
                } return; 
            }
            if(rawKey.length > 1 && rawKey !== 'Enter') return; if(!targetChar) return; 
            totalKeys++; userStats.totalKeystrokes += 1;

            if(key === targetChar) {
                correctKeys++; combo++;
                const isFire = combo >= COMBO_THRESHOLD;
                if(isFire) {
                    document.body.classList.add('on-fire'); keyboardContainer.classList.add('rgb-mode');
                    document.getElementById('combo').classList.add('fire'); document.getElementById('combo-container').classList.add('high-combo');
                    if(visualKey) { const r = visualKey.getBoundingClientRect(); spawnFireParticles(r.left + r.width/2, r.top + r.height/2); appWrapper.classList.add('shake-screen'); setTimeout(()=>appWrapper.classList.remove('shake-screen'), 200); }
                }
                checkAchievements({ maxCombo: combo }); playSound(isFire ? 'epic' : 'click'); 
                if (targetChar === ' ') { const words = currentTextStr.split(' '); const completed = currentTextStr.substring(0, currentIndex); const idx = completed.split(' ').length - 1; if (words[idx]) speakWord(words[idx]); } else if (currentIndex === currentTextStr.length - 1) { const words = currentTextStr.split(' '); speakWord(words[words.length-1]); }
                allCharElements[currentIndex].classList.add('correct'); allCharElements[currentIndex].classList.remove('current'); currentIndex++;
                if(currentIndex < currentTextStr.length) { allCharElements[currentIndex].classList.add('current'); } else { saveHistory(); setTimeout(initRound, 200); }
            } else {
                playSound('error'); combo = 0;
                document.body.classList.remove('on-fire'); keyboardContainer.classList.remove('rgb-mode');
                document.getElementById('combo').classList.remove('fire'); document.getElementById('combo-container').classList.remove('high-combo');
                allCharElements[currentIndex].classList.add('wrong'); 
                if(visualKey) { visualKey.classList.add('wrong-shake'); setTimeout(()=>visualKey.classList.remove('wrong-shake'), 300); }
            }
            document.getElementById('combo').innerText = combo; document.getElementById('accuracy').innerText = Math.round((correctKeys/totalKeys)*100) + '%'; if(startTime) document.getElementById('wpm').innerText = Math.round((correctKeys/5)/((Date.now()-startTime)/60000));
            updateHandsPosition(); autoScroll(); 
        }
        document.addEventListener('keydown', processInput);
    </script>
</body>
</html>